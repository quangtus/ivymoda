<?php
// filepath: C:\xampp\htdocs\ivymoda\ivymoda_mvc\app\models\ProductModel.php

class ProductModel extends Model {
    protected $table = 'tbl_sanpham';
    
    public function __construct() {
        parent::__construct();
    }
    
    /**
     * Lấy tất cả sản phẩm với phân trang
     */
    public function getAllProductsWithPagination($limit = 10, $offset = 0) {
        $limit = (int)$limit;
        $offset = (int)$offset;
        
        $query = "SELECT p.*, c.danhmuc_ten, b.loaisanpham_ten
                  FROM {$this->table}     /**
     * Lấy sản phẩm mới nhất
     */
    public function getNewProducts($limit = 8) {
        $query = "SELECT p.*, c.danhmuc_ten, l.loaisanpham_ten,
                  COALESCE(
                      (SELECT ap.anh_path FROM tbl_anhsanpham ap 
                       WHERE ap.sanpham_id = p.sanpham_id 
                       ORDER BY ap.is_primary DESC, ap.anh_id ASC LIMIT 1),
                      p.sanpham_anh
                  ) as first_image
                  FROM tbl_sanpham p
                  LEFT JOIN tbl_danhmuc c ON p.danhmuc_id = c.danhmuc_id
                  LEFT JOIN tbl_loaisanpham l ON p.loaisanpham_id = l.loaisanpham_id
                  WHERE p.sanpham_status = 1
                  ORDER BY p.created_at DESC 
                  LIMIT $limit";
        
        return $this->getAll($query);
    }    LEFT JOIN tbl_danhmuc c ON p.danhmuc_id = c.danhmuc_id
                  LEFT JOIN tbl_loaisanpham b ON p.loaisanpham_id = b.loaisanpham_id
                  ORDER BY p.sanpham_id DESC
                  LIMIT $offset, $limit";
        
        return $this->getAll($query);
    }
    
    /**
     * Lấy tổng số sản phẩm
     */
    public function getTotalProducts() {
        $query = "SELECT COUNT(*) as total FROM {$this->table}";
        $result = $this->getOne($query);
        
        if ($result) {
            if (is_object($result) && isset($result->total)) {
                return $result->total;
            } elseif (is_array($result) && isset($result['total'])) {
                return $result['total'];
            }
        }
        
        return 0;
    }
    
    /**
     * Lấy danh sách ảnh của sản phẩm
     * @param int $productId ID sản phẩm
     * @param int|null $colorId ID màu (tùy chọn)
     * @param bool $includeDefault Có bao gồm ảnh mặc định nếu không có ảnh theo màu không
     * @return array Danh sách ảnh sản phẩm
     */
    public function getProductImages($productId, $colorId = null, $includeDefault = true) {
        $params = [$productId];
        $query = "SELECT ap.*, spc.sanpham_color_id, spc.color_id, c.color_ten, c.color_anh 
                  FROM tbl_anhsanpham ap
                  LEFT JOIN tbl_sanpham_color spc ON ap.sanpham_color_id = spc.sanpham_color_id
                  LEFT JOIN tbl_color c ON spc.color_id = c.color_id
                  WHERE ap.sanpham_id = ?";
        
        // Lọc theo màu nếu được chỉ định
        if ($colorId !== null) {
            $query .= " AND spc.color_id = ?";
            $params[] = (int)$colorId;
        }
        
        $query .= " ORDER BY ap.is_primary DESC, ap.anh_id ASC";
        
        $images = $this->getAll($query, $params);
        
        // Nếu không có ảnh và yêu cầu ảnh mặc định
        if (empty($images) && $includeDefault) {
            // Lấy thông tin sản phẩm để lấy ảnh chính
            $product = $this->getOne("SELECT sanpham_anh FROM tbl_sanpham WHERE sanpham_id = ?", [$productId]);
            
            if ($product) {
                $sanphamAnh = is_object($product) ? $product->sanpham_anh : ($product['sanpham_anh'] ?? '');
                if (!empty($sanphamAnh)) {
                    $images = [
                        (object)[
                            'anh_id' => 0,
                            'sanpham_id' => $productId,
                            'anh_path' => $sanphamAnh,
                            'is_primary' => 1,
                            'sanpham_color_id' => null,
                            'color_ten' => null,
                            'color_anh' => null
                        ]
                    ];
                }
            }
        }
        
        return $images;
    }
    
    /**
     * Lấy ảnh chính của sản phẩm
     */
    public function getPrimaryProductImage($productId) {
        $query = "SELECT * FROM tbl_anhsanpham 
                  WHERE sanpham_id = ? AND is_primary = 1 
                  LIMIT 1";
        
        return $this->getOne($query, [$productId]);
    }
    
    /**
     * Thêm ảnh sản phẩm
     */
    public function addProductImage($productId, $imagePath, $isPrimary = 0, $sanphamColorId = null) {
        $query = "INSERT INTO tbl_anhsanpham (sanpham_id, sanpham_color_id, anh_path, is_primary) 
                  VALUES (?, ?, ?, ?)";
        
        return $this->db->query($query, [$productId, $sanphamColorId, $imagePath, $isPrimary]);
    }

    /**
     * Lấy danh sách màu có ảnh cho sản phẩm
     */
    public function getProductAvailableColors($productId) {
        $query = "SELECT DISTINCT c.color_id, c.color_ten, c.color_anh
                  FROM tbl_anhsanpham ap
                  INNER JOIN tbl_sanpham_color spc ON ap.sanpham_color_id = spc.sanpham_color_id
                  INNER JOIN tbl_color c ON spc.color_id = c.color_id
                  WHERE ap.sanpham_id = ?
                  ORDER BY c.color_ten";
        return $this->getAll($query, [$productId]);
    }

    /**
     * Lấy danh sách màu được gán cho sản phẩm (từ bảng liên kết)
     */
    public function getProductColors(int $productId) {
        $this->ensureProductColorPivot();
        $query = "SELECT c.color_id, c.color_ten, c.color_anh, spc.is_default
                  FROM tbl_sanpham_color spc
                  INNER JOIN tbl_color c ON spc.color_id = c.color_id
                  WHERE spc.sanpham_id = ?
                  ORDER BY spc.is_default DESC, c.color_ten";
        return $this->getAll($query, [$productId]);
    }

    /**
     * Lấy danh sách ID màu của sản phẩm
     */
    public function getProductColorIds(int $productId): array {
        $colors = $this->getProductColors($productId);
        if (empty($colors)) {
            return [];
        }

        return array_map(function ($color) {
            if (is_object($color) && isset($color->color_id)) {
                return (int)$color->color_id;
            }
            if (is_array($color) && isset($color['color_id'])) {
                return (int)$color['color_id'];
            }
            return (int)$color;
        }, $colors);
    }
    
    /**
     * Cập nhật ảnh chính của sản phẩm
     */
    public function setPrimaryImage($productId, $imageId) {
        try {
            // Bỏ primary của tất cả ảnh sản phẩm
            $query1 = "UPDATE tbl_anhsanpham SET is_primary = 0 WHERE sanpham_id = ?";
            $this->execute($query1, [$productId]);
            
            // Set ảnh được chọn làm primary
            $query2 = "UPDATE tbl_anhsanpham SET is_primary = 1 WHERE anh_id = ? AND sanpham_id = ?";
            $result = $this->execute($query2, [$imageId, $productId]);
            
            if ($result) {
                // Lấy đường dẫn ảnh mới
                $newImage = $this->getOne("SELECT anh_path FROM tbl_anhsanpham WHERE anh_id = ?", [$imageId]);
                
                if ($newImage) {
                    $imagePath = is_object($newImage) ? $newImage->anh_path : ($newImage['anh_path'] ?? '');
                    if (!empty($imagePath)) {
                        // Cập nhật sanpham_anh trong tbl_sanpham để đồng bộ
                        $query3 = "UPDATE tbl_sanpham SET sanpham_anh = ? WHERE sanpham_id = ?";
                        $this->execute($query3, [$imagePath, $productId]);
                    }
                }
            }
            
            return $result;
        } catch (Exception $e) {
            error_log("setPrimaryImage Error: " . $e->getMessage());
            return false;
        }
    }
    
    /**
     * Xóa ảnh sản phẩm
     */
    public function deleteProductImage($imageId) {
        $query = "DELETE FROM tbl_anhsanpham WHERE anh_id = ?";
        return $this->db->query($query, [$imageId]);
    }

    /**
     * Xóa tất cả ảnh theo sản phẩm và màu
     */
    public function deleteImagesByProductAndColor(int $productId, int $colorId) {
        $productId = (int)$productId;
        $colorId = (int)$colorId;
        return $this->execute("DELETE ap FROM tbl_anhsanpham ap 
                              INNER JOIN tbl_sanpham_color spc ON ap.sanpham_color_id = spc.sanpham_color_id 
                              WHERE ap.sanpham_id = $productId AND spc.color_id = $colorId");
    }
    
    /**
     * Lấy tất cả sản phẩm
     */
    public function getAllProducts() {
        $query = "SELECT p.*, c.danhmuc_ten, b.loaisanpham_ten
                  FROM {$this->table} p
                  LEFT JOIN tbl_danhmuc c ON p.danhmuc_id = c.danhmuc_id
                  LEFT JOIN tbl_loaisanpham b ON p.loaisanpham_id = b.loaisanpham_id
                  ORDER BY p.sanpham_id DESC";
        
        return $this->getAll($query);
    }
    
    /**
     * Lấy sản phẩm nổi bật cho frontend
     */
    public function getFeaturedProducts($limit = 8) {
        $query = "SELECT p.*, c.danhmuc_ten 
                  FROM tbl_sanpham p 
                  LEFT JOIN tbl_danhmuc c ON p.danhmuc_id = c.danhmuc_id
                  WHERE p.sanpham_status = 1 
                  ORDER BY p.sanpham_id DESC 
                  LIMIT $limit";
                  
        return $this->getAll($query);
    }
    
    /**
     * Lấy sản phẩm theo danh mục
     */
    public function getProductsByCategory($category_id, $limit = 12, $offset = 0) {
        $category_id = (int)$category_id;
        $limit = (int)$limit;
        $offset = (int)$offset;
        
        $query = "SELECT p.*, c.danhmuc_ten, b.loaisanpham_ten
                  FROM {$this->table} p
                  LEFT JOIN tbl_danhmuc c ON p.danhmuc_id = c.danhmuc_id
                  LEFT JOIN tbl_loaisanpham b ON p.loaisanpham_id = b.loaisanpham_id
                  WHERE p.danhmuc_id = $category_id
                  ORDER BY p.sanpham_id DESC
                  LIMIT $offset, $limit";
        
        return $this->getAll($query);
    }
    
    /**
     * Lấy sản phẩm theo loại sản phẩm
     */
    public function getProductsBySubcategory($subcategory_id, $limit = 12, $offset = 0) {
        $subcategory_id = (int)$subcategory_id;
        $limit = (int)$limit;
        $offset = (int)$offset;
        
        $query = "SELECT p.*, c.danhmuc_ten, b.loaisanpham_ten
                  FROM {$this->table} p
                  LEFT JOIN tbl_danhmuc c ON p.danhmuc_id = c.danhmuc_id
                  LEFT JOIN tbl_loaisanpham b ON p.loaisanpham_id = b.loaisanpham_id
                  WHERE p.loaisanpham_id = $subcategory_id
                  ORDER BY p.sanpham_id DESC
                  LIMIT $offset, $limit";
        
        return $this->getAll($query);
    }
    
    /**
     * Lấy ID của bản ghi vừa insert
     */
    public function getLastInsertId() {
        return $this->db->lastInsertId();
    }

    /**
     * Thêm sản phẩm mới và trả về ID
     */
    public function addProduct($title, $code, $category_id, $subcategory_id, $price, $description, $care_instructions, $image) {
        $title = trim((string)$title);
        $code = trim((string)$code);
        $category_id = (int)$category_id;
        $subcategory_id = (int)$subcategory_id;
        $price = trim((string)$price);
        $description = (string)$description;
        $care_instructions = (string)$care_instructions;
        $image = trim((string)$image);

        if ($this->getOne("SELECT sanpham_id FROM {$this->table} WHERE sanpham_ma = ?", [$code])) {
            return "Mã sản phẩm đã tồn tại";
        }

        $query = "INSERT INTO tbl_sanpham 
                  (sanpham_tieude, sanpham_ma, danhmuc_id, loaisanpham_id, sanpham_gia, sanpham_chitiet, sanpham_baoquan, sanpham_anh) 
                  VALUES (?, ?, ?, ?, ?, ?, ?, ?)";

        $result = $this->db->query($query, [
            $title,
            $code,
            $category_id,
            $subcategory_id,
            $price,
            $description,
            $care_instructions,
            $image
        ]);

        if ($result) {
            $insertId = $this->db->lastInsertId();
            return $insertId ? (int)$insertId : true;
        }

        return "Không thể thêm sản phẩm";
    }

    /**
     * Đảm bảo bảng tbl_sanpham_color tồn tại
     */
    private function ensureProductColorPivot() {
        $this->execute(
            "CREATE TABLE IF NOT EXISTS tbl_sanpham_color (
                sanpham_color_id INT AUTO_INCREMENT PRIMARY KEY,
                sanpham_id INT NOT NULL,
                color_id INT NOT NULL,
                is_default TINYINT(1) DEFAULT 0,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                UNIQUE KEY unique_product_color (sanpham_id, color_id),
                FOREIGN KEY (sanpham_id) REFERENCES tbl_sanpham(sanpham_id) ON DELETE CASCADE,
                FOREIGN KEY (color_id) REFERENCES tbl_color(color_id) ON DELETE CASCADE
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4"
        );
    }

    /**
     * Thiết lập danh sách màu cho sản phẩm
     */
    public function setProductColors(int $productId, array $colorIds): bool {
        $this->ensureProductColorPivot();
        
        // Xóa các mapping cũ
        $this->execute("DELETE FROM tbl_sanpham_color WHERE sanpham_id = ?", [$productId]);

        // Thêm mapping mới
        if (empty($colorIds)) {
            return true;
        }

        $firstColor = true;
        foreach ($colorIds as $colorId) {
            $colorId = (int)$colorId;
            if ($colorId > 0) {
                $isDefault = $firstColor ? 1 : 0;
                $this->execute(
                    "INSERT INTO tbl_sanpham_color (sanpham_id, color_id, is_default) VALUES (?, ?, ?)",
                    [$productId, $colorId, $isDefault]
                );
                $firstColor = false;
            }
        }
        
        return true;
    }

    /**
     * Lấy thông tin chi tiết sản phẩm
     */
    public function getProductById($product_id) {
        $product_id = (int)$product_id;
        
        $query = "SELECT p.*, c.danhmuc_ten, b.loaisanpham_ten
                  FROM {$this->table} p
                  LEFT JOIN tbl_danhmuc c ON p.danhmuc_id = c.danhmuc_id
                  LEFT JOIN tbl_loaisanpham b ON p.loaisanpham_id = b.loaisanpham_id
                  WHERE p.sanpham_id = ?";
        
        return $this->getOne($query, [$product_id]);
    }
    
    /**
     * Cập nhật sản phẩm
     */
    public function updateProduct($id, $title, $code, $category_id, $subcategory_id, $price, $description, $care_instructions, $image) {
        // Escape dữ liệu
        $id = (int)$id;
        $title = $this->escape($title);
        $code = $this->escape($code);
        $category_id = (int)$category_id;
        $subcategory_id = (int)$subcategory_id;
        $price = $this->escape($price);
        $description = $this->escape($description);
        $care_instructions = $this->escape($care_instructions);
        $image = $this->escape($image);
        
        // Kiểm tra mã sản phẩm trùng lặp (trừ sản phẩm hiện tại)
        $check_query = "SELECT * FROM {$this->table} WHERE sanpham_ma = '$code' AND sanpham_id != $id";
        if($this->getOne($check_query)) {
            return "Mã sản phẩm đã tồn tại";
        }
        
        $query = "UPDATE {$this->table} SET 
                    sanpham_tieude = '$title', 
                    sanpham_ma = '$code', 
                    danhmuc_id = $category_id, 
                    loaisanpham_id = $subcategory_id, 
                    sanpham_gia = '$price', 
                    sanpham_chitiet = '$description', 
                    sanpham_baoquan = '$care_instructions'";
                    
        // Chỉ cập nhật ảnh nếu có
        if (!empty($image)) {
            $query .= ", sanpham_anh = '$image'";
        }
        
        $query .= " WHERE sanpham_id = $id";
        
        if($this->execute($query)) {
            return true;
        } else {
            return "Cập nhật sản phẩm thất bại";
        }
    }
    
    /**
     * Xóa sản phẩm
     */
    public function deleteProduct($id) {
        $id = (int)$id;
        
        $query = "DELETE FROM {$this->table} WHERE sanpham_id = $id";
        
        if($this->execute($query)) {
            return true;
        } else {
            return "Xóa sản phẩm thất bại";
        }
    }
    
    /**
     * Lấy tất cả màu sắc
     */
    public function getAllColors() {
        $query = "SELECT * FROM tbl_color ORDER BY color_id";
        return $this->getAll($query);
    }

    /**
     * Tìm kiếm sản phẩm
     */
    public function searchProducts($keyword, $category_id = null, $min_price = null, $max_price = null, $limit = 12, $offset = 0) {
        $keyword = $this->escape($keyword);
        $limit = (int)$limit;
        $offset = (int)$offset;
        
        $query = "SELECT p.*, c.danhmuc_ten, b.loaisanpham_ten
                  FROM {$this->table} p
                  LEFT JOIN tbl_danhmuc c ON p.danhmuc_id = c.danhmuc_id
                  LEFT JOIN tbl_loaisanpham b ON p.loaisanpham_id = b.loaisanpham_id
                  WHERE (p.sanpham_tieude LIKE '%$keyword%' OR p.sanpham_chitiet LIKE '%$keyword%')";
        
        if($category_id) {
            $category_id = (int)$category_id;
            $query .= " AND p.danhmuc_id = $category_id";
        }
        
        if($min_price) {
            $min_price = (float)$min_price;
            $query .= " AND CAST(p.sanpham_gia AS DECIMAL) >= $min_price";
        }
        
        if($max_price) {
            $max_price = (float)$max_price;
            $query .= " AND CAST(p.sanpham_gia AS DECIMAL) <= $max_price";
        }
        
        $query .= " ORDER BY p.sanpham_id DESC LIMIT $offset, $limit";
        
        return $this->getAll($query);
    }
    
    /**
     * Lấy sản phẩm liên quan
     */
    public function getRelatedProducts($product_id, $category_id, $limit = 4) {
        $product_id = (int)$product_id;
        $category_id = (int)$category_id;
        $limit = (int)$limit;
        
        $query = "SELECT p.*, c.danhmuc_ten, b.loaisanpham_ten
                  FROM {$this->table} p
                  LEFT JOIN tbl_danhmuc c ON p.danhmuc_id = c.danhmuc_id
                  LEFT JOIN tbl_loaisanpham b ON p.loaisanpham_id = b.loaisanpham_id
                  WHERE p.danhmuc_id = $category_id AND p.sanpham_id != $product_id
                  ORDER BY p.sanpham_id DESC
                  LIMIT $limit";
        
        return $this->getAll($query);
    }

    /**
     * Lấy sản phẩm với chi tiết và ảnh đầu tiên
     */
    public function getProductsWithDetails($limit = 10, $offset = 0) {
        $query = "SELECT p.*, c.danhmuc_ten, l.loaisanpham_ten,
                  (SELECT ap.anh_path FROM tbl_anhsanpham ap 
                   WHERE ap.sanpham_id = p.sanpham_id 
                   ORDER BY ap.is_primary DESC, ap.anh_id ASC LIMIT 1) as first_image
                  FROM tbl_sanpham p
                  LEFT JOIN tbl_danhmuc c ON p.danhmuc_id = c.danhmuc_id
                  LEFT JOIN tbl_loaisanpham l ON p.loaisanpham_id = l.loaisanpham_id
                  WHERE p.sanpham_status = 1
                  ORDER BY p.sanpham_id DESC 
                  LIMIT $limit OFFSET $offset";
        
        return $this->getAll($query);
    }
    
    /**
     * Lấy sản phẩm nổi bật với đầy đủ thông tin và ảnh đầu tiên
     */
    public function getFeaturedProductsWithDetails($limit = 8) {
        $query = "SELECT p.*, c.danhmuc_ten, l.loaisanpham_ten,
                  COALESCE(
                      (SELECT ap.anh_path FROM tbl_anhsanpham ap 
                       WHERE ap.sanpham_id = p.sanpham_id 
                       ORDER BY ap.is_primary DESC, ap.anh_id ASC LIMIT 1),
                      p.sanpham_anh
                  ) as first_image
                  FROM tbl_sanpham p
                  LEFT JOIN tbl_danhmuc c ON p.danhmuc_id = c.danhmuc_id
                  LEFT JOIN tbl_loaisanpham l ON p.loaisanpham_id = l.loaisanpham_id
                  WHERE p.sanpham_status = 1
                  ORDER BY p.sanpham_id DESC 
                  LIMIT $limit";
        
        return $this->getAll($query);
    }
    
    /**
     * Lấy sản phẩm bán chạy với ảnh đầu tiên
     */
    public function getBestSellingProducts($limit = 8) {
        $query = "SELECT p.*, c.danhmuc_ten, l.loaisanpham_ten,
                  COALESCE(
                      (SELECT ap.anh_path FROM tbl_anhsanpham ap 
                       WHERE ap.sanpham_id = p.sanpham_id 
                       ORDER BY ap.is_primary DESC, ap.anh_id ASC LIMIT 1),
                      p.sanpham_anh
                  ) as first_image
                  FROM tbl_sanpham p
                  LEFT JOIN tbl_danhmuc c ON p.danhmuc_id = c.danhmuc_id
                  LEFT JOIN tbl_loaisanpham l ON p.loaisanpham_id = l.loaisanpham_id
                  WHERE p.sanpham_status = 1
                  ORDER BY p.sanpham_id DESC 
                  LIMIT $limit";
        
        return $this->getAll($query);
    }
                  LIMIT $limit";
        
        return $this->getAll($query);
    }
    
    /**
     * Lấy sản phẩm mới với ảnh đầu tiên
     */
    public function getNewProducts($limit = 8) {
        $query = "SELECT p.*, c.danhmuc_ten, l.loaisanpham_ten,
                  (SELECT ap.anh_path FROM tbl_anhsanpham ap 
                   WHERE ap.sanpham_id = p.sanpham_id 
                   ORDER BY ap.is_primary DESC, ap.anh_id ASC LIMIT 1) as first_image
                  FROM tbl_sanpham p
                  LEFT JOIN tbl_danhmuc c ON p.danhmuc_id = c.danhmuc_id
                  LEFT JOIN tbl_loaisanpham l ON p.loaisanpham_id = l.loaisanpham_id
                  WHERE p.sanpham_status = 1
                  ORDER BY p.sanpham_id DESC 
                  LIMIT $limit";
        
        return $this->getAll($query);
    }
    
    /**
     * Tăng lượt xem sản phẩm
     * Note: Cột sanpham_luot_xem không còn trong database mới
     */
    public function incrementView($productId) {
        // Skip - sanpham_luot_xem column doesn't exist in new database
        return true;
    }

    /**
     * Đếm tất cả sản phẩm
     */
    public function countAll() {
        $query = "SELECT COUNT(*) as total FROM tbl_sanpham";
        $result = $this->getOne($query);
        
        if ($result) {
            if (is_object($result) && isset($result->total)) {
                return $result->total;
            } elseif (is_array($result) && isset($result['total'])) {
                return $result['total'];
            }
        }
        
        return 0;
    }
}